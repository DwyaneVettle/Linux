# 第九章  常用服务器的搭建

## 1.配置FTP服务器

### 1.1.FTP简介

​	FTP（File Transfer Protocol，文件传送协议）是TCP/IP网络上两台计算机间传送文件的协议，FTP是在TCP/IP网络和Internet上最早使用的协议之一，它属于网络协议组的应用层。FTP客户机可以给服务器发出命令来下载文件、上传文件、创建或改变服务器上的目录。FTP服务一般运行在20和21两个端口。端口20用于在FTP客户端和服务器之间传输数据流，而端口21用于传输控制流，并且是命令通向FTP服务器的入口。当数据通过数据流传输时，控制流处于空闲状态。

​	FTP的优点如下：

1. 促进文件（计算机程序或数据）的共享；
2. 鼓励间接或者隐式使用远程计算机；
3. 向用户屏蔽不同主机中各种文件存储系统的细节；
4. 能够可靠和高效的传输数据。



​	FTP的缺点如下：

1. 密码和文件内容都是用明文传输，可能遭受窃听；
2. 因为必须开放一个随机的端口来建立连接，当防火墙存在时，客户端很难过滤处于主动模式下的FTP流浪。这个问题通过使用被动模式的FTP基本上得到了解决；
3. 服务器可能会被告连接一个第三方计算机的保留端口。



​	在FTP的使用中，有两个经常遇到的概念：下载(download)和上传(upload)。下载文件就是从远程主机复制文件到自己的计算机；上传文件就是从自己的计算机复制至远程主机。



### 1.2.安装FTP服务器

​	在Ubuntu下常用的FTP服务器软件是vsftpd（very secure FTP daemon）。

- **安装FTP服务器软件：**

```shell
apt-get install vsftpd
```

<img src="https://gitee.com/zou_tangrui/note-pic/raw/master/img/202309201102365.png" alt="image-20230919172740925" style="zoom:50%;" />

​	安装完成后，系统会在/etc/init.d目录下创建一个vsftpd的文件脚本，并会在系统的启动过程中自动运行vsftpd守护进程。在终端下，使用命令显示/etc/init.d/vsftpd文件内容，并可以使用`pidof`命令查看守护进程的PID

```shell
cat /etc/init.d/vsftpd
```

```shell
pidof vsftpd
```

<img src="https://gitee.com/zou_tangrui/note-pic/raw/master/img/202309201102375.png" alt="image-20230919173106533" style="zoom:50%;" />

- **vsftpd程序的启动、停止和重新启动：**

```shell
service vsftpd start					# 启动vsftpd
service vsftpd stop 					# 停止vsftpd
service vsftpd restart					# 重启vsftpd
```



### 1.3.配置FTP服务器

​	vsftpd的配置文件是/etc/vsftpd.conf。在Shell终端下，可以通过`cat`命令查看vsftpd.conf的内容。常用的参数如下：

- anonymous_enable：是否允许匿名用户登录
- local_enable：是否允许系统用户登录
- write_enable：是否允许使用任何可以修改文件系统的FTP命令
- anon_upload_enable：是否允许匿名用户上传文件
- anon_mkdir_write_enable：是否允许匿名用户创建新目录
- idle_session_timeout：空闲连接超时时间
- data_connection_timenout：数据传输超时时间



​	安装vsftpd后，需要进行一些设置，才能利用FTP客户端正常使用FTP服务器，具体设置步骤如下：

1. 为FTP服务器添加用户，使用以下命令添加一个myftp的用户：

```shell
sudo useradd -m myftp
```

​	2.为myftp用户设置密码：

```shell
sudo passwd myftp
```

​	3.在/home/myftp/目录中创建ftpdir目录，作为FTP的根目录：

```shell
cd /home/myftp
mkdir mtpdir
```

​	4.修改vsftpd.conf文件，配置目录信息，并添加以下内容：

```shell
local_root=/home/myftp/ftpdir
allow_writeable_chroot=YES
```

​	编辑方法是：将以上内容添加到下图位置，并删除`chroot_locla_user=YES`行首的#符号:

<img src="https://gitee.com/zou_tangrui/note-pic/raw/master/img/202309201102376.png" alt="image-20230920101004217" style="zoom:50%;" />

<img src="https://gitee.com/zou_tangrui/note-pic/raw/master/img/202309201102377.png" alt="image-20230920101228261" style="zoom:50%;" />

​	5.启动FTP服务器：

```shell
service vsftpd start
```

​	6.在/home/myftp/ftpdit目录中新建一个文件，或者复制一个文件，作为FTP服务器的共享文件，并修改`/etc/vsftpd.conf`权限：

```shell
touch /home/myftp/ftpdir/
chmod a+w /etc/vsftpd.conf
```

​	7.在Mobaxterm中使用FTP连接方式连接FTP服务器（在连接配置界面中可以看到服务器的IP地址）：

<img src="https://gitee.com/zou_tangrui/note-pic/raw/master/img/202309201102378.png" style="zoom:50%;" />

​	<img src="https://gitee.com/zou_tangrui/note-pic/raw/master/img/202309201102379.png" style="zoom:50%;" />

​	输入密码后，我们就可以看到创建的共享文件了：

<img src="https://gitee.com/zou_tangrui/note-pic/raw/master/img/202309201102380.png" alt="image-20230920103347423" style="zoom:50%;" />



​	FTP功能介绍：

<img src="https://gitee.com/zou_tangrui/note-pic/raw/master/img/202309201102381.png" style="zoom:50%;" />

### 1.4.功能测试：

​	点击上传和下载都能成功：

<img src="https://gitee.com/zou_tangrui/note-pic/raw/master/img/202309201102382.png" alt="image-20230920105648736" style="zoom:50%;" />

​	如果出现553或550等报错信息，可以参考：

```shell
write_enable=YES 未修改
文件夹权限过低，chmod 777 /home/xxx
未指定文件夹，设置 local_root=/home/xxx
```



## 2.配置Samba服务器

### 2.1.SMB协议和Samba服务器简介

​	SMB(Server Message Block，服务器信息块)通信协议是微软公司和英特尔公司在1987年制定的，主要是作为微软网络的通信协议。SMB是会话层和表示层以及小部分应用层的协议。SMB使用了NetBIOs的API，该协议的增强版本是CIFS（普通Internet文件系统）。

​	与其他标准的TCP/IP不同，SMB是一种复杂的协议，这是因为随着Windows计算机的开发，越来越多的功能被加入该协议中，很难区分哪些概念和功能应该属于Windows本身，哪些概念和功能应该属于SMB协议。其他网络协议由于是先有协议，再实现相关的软件，因此结构比较清晰、简洁；而SMB协议一直是与微软公司的操作系统混在一起进行开发的，因此协议中包含了大量的Windows系统中的概念。

​	在Linux环境下，安装SMB协议的主要目的是为了和Windows系统进行文件和打印共享，它可以使Linux计算机出现在Windows计算机的网上邻居中，对于Windows用户而言，可以像使用Windows计算机一样使用Linux计算机进行文件和打印共享。

​	Samba是SMB协议的一种实现，早期Samba源自UNIX系统。Samba套件包括客户端、服务器等多个软件包。客户端软件包使得Linux用户也能与Windows服务器联网通信；服务器软件包使得Linux系统成为一个SMB/CIFS服务器，提供SMB服务和接口，实现Windows环境中的网络文件和打印共享。

​	在Ubuntu系统中，需要单独安装Samba套件，它包括以下软件包：

- Samba：服务器
- samba-common：通用实用程序
- samba-client：客户端
- samba-doc：非PDF格式文档
- samba-doc-pdf：PDF格式文档
- system-config-samba：GNOME管理工具
- swat：基于浏览器的管理工具
- sabfs：SMB文件安装与卸载工具

### 2.2.安装Samba服务器

```shell
apt-get update							# 同步/etc/apt/sources.list和/etc/apt/sources.list.d中列出的源的索引,以获取最新的软件包
apt-get upgrade							# 以最新版本更新软件包
apt-get dist-upgrade					# 根据依赖关系添加或删除包
apt-get install samba samba-common
```

