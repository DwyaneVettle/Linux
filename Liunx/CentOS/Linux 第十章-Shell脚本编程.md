# Linux 第十章-Shell脚本编程

​	在Linux系统中，Shell不仅是为用户提供了交互式的命令执行界面，而且还可以通过脚本语言进行编程。通过Shell编程，可以使大量任务自动完成，从而提高系统维护的工作效率，能够根据各种任务需求编写出像相应的Shell脚本，这是一个Linux运维人员需要掌握的基本技能。

​	

## 1.创建Shell脚本

### 	1.1.什么是Shell脚本

​	一个计算机程序主要有指令和数据两部分组成。从编程风格角度，目前的编程语言主要分为面向过程编程和面向对象编程两大类。传统的C、Basic语言等都是采用面向过程编程，这种编程以指令为中心，数据服务于指令，在编程上一般都是根据业务逻辑从上到下来编写代码。目前主流编程语言则是采用面向对象编程，一种方式以数据为中心，指令服务于数据，主要特点是类和对象的使用。我们编写Shell来编写脚本完成一些自动化运维任务，不需要开发一些大型程序，因此**Shell脚本编程属于面向过程编程**。

​	另外，从执行方式角度，编程语言又分为编译型和解释型。

​	编译型语言需要将整个程序转换成二进制代码之后，再由计算机执行，如C、JAVA等。解释型语言则是解释一行运行一行，如HTML等。**Shell脚本语言属性典型的编译型语言。**



### 1.2.Shell脚本的基本语法

​	Shell脚本基本语法比较简单，主要由头部份、注释部分以及可执行语句组成。

​	一个简单的Shell脚本程序如下：

```shell
#! /bin/bash
# This is my first shell-script
date 
echo 'Hello World!'
```

​	**在脚本语句的第一行要求顶格写出解释器的路径，用于指明解释型执行当前脚本的解释器程序文件。**所谓解释器指的就是Shell，对于CentOS系统，默认使用的Shell是Bash，因而这里需要指定的是Shell的完整路径"/bin/shell"。在很多shell脚本中，还会使用sh作为解释器，sh是由Solaris和FreeBSD系统中默认使用的shell，在CentOS系统中，sh其实是Bash的一个软链接，因而在脚本开头使用"/bin/sh"和"/bin/bash"没有区别。

```shell
ll /bin/sh
```



### 1.3.编写Shell脚本

​	编写一个完整的可执行Shell脚本需要以下几个步骤：

1.  创建文件

   ```shell
   vim fisrt.sh
   #!/bin/bash
   date
   echo "Hello World!"
   ```

   

2.  设置可执行权限

   ```shell
   chmod a+x first.sh
   ll first.sh
   ```

3.  执行Shell脚本，由于Shell脚本并不是外部命令，它的路径并不在PATH变量中，因而要执行shell脚本，必须要指明脚本路径

   ```shell
   /root/first.sh
   ```

   如果shell是在当前路径下，更推荐以下执行方式：

   ```shell
   ./first.sh
   ```

   或者用bash命令执行

   ```shell
   bash first.sh
   ```

4. bash脚本也是一个命令，**通过它的"-x"选项可以输出脚本的执行过程，通常用于对脚本进行调试**。运行脚本结果中，带"+"的输出行是执行的命令。

   ```shell
   bash -x first.sh
   ```

   **通过bash的"-n"选项可以检查脚本的语法错误：**

   ```shell
   bash -n first.sh
   ```




## 2.Shell变量

​	与其他编程语言一样，在Shell脚本程序中也离不开各种变量，通过变量可以保存系统和用户需要使用的特定参数或数值。

​	Shell脚本中常见的变量类型包括：

- **用户自定义变量：**由用户自己定义、使用和修改，作用域仅在当前Shell进程中；
- **环境变量：**由系统定义，主要用于设置用户工作环境；
- **位置变量：**通过命令行给脚本程序传递参数；
- **预定义变量：**bash中内置的，有特殊功能的变量，不能直接修改，如变量$?可以返回命令执行后的状态。

### 2.1.用户自定义变量

​	**用户自定义变量是由用户自己定义的变量，只在用户自己的Shell环境中有效，因此称为本地变量。**在编写Shell脚本程序时，通常会设定一些自定义变量，以适应程序执行过程中的各种需要，满足不同需求。

1. **定义变量**

   ​	**bash中的变量无需事先声明，而是直接指定变量名称及初始值即可。**相当于把声明和赋值过程同时实现，**bash中的变量也无需定义类型，默认把所有的变量都视为字符。**

   **格式：**

   ```shell
   变量名=变量值
   ```

   变量名只能包含数字、字母和下划线，而且不能以数字开头。在位变量命名时，变量名最好见名知义，命名机制遵循某种规则。另外，不允许使用程序的保留字为变量命名，如if、then、else等。

![image-20211231202157907](https://gitee.com/zou_tangrui/note-pic/raw/master/img/202302171657579.png)

```shell
day="Sunday"									# 定义变量day
echo $day										# 输出变量的值
```

​	**当变量名容易跟紧跟其他字符相混淆时，需要加{}将其包裹起来，以便于解释器识别变量的边界。**

```shell
echo ${day}Morning								# 在变量day后紧跟字符Morning并一起显示
```

​	2.**变量赋值**

​	在符号"="后边直接指定变量内容是为变量赋值的最基本方法。除此之外，还有一些常用的变量赋值方法，包括双引号、单引号、反撇号、read命令。

- **双引号**

  在位变量赋值时，如果变量值中包含了空格，需要将整个字符串用双引号括起来。

  ```shell
  today="This is Friday"
  echo $today
  ```

  双引号被称为弱引用，当使用双引号时，允许在双引号内使用$符号来引用其他变量的值：

  ```shell
  echo $day
  today="Today is $day"
  echo $today
  ```

- **单引号**

  单引号和双引号最大的不同就是单引号内不会输出变量的值。

  ```shell
  tomorrow='Tomorrow is $day'
  echo $tomorrow
  ```

- **反撇号`**

  ​	反撇号被称为命令引用，**当使用反撇号时，允许将执行特定命令的输出结果赋值给变量**，反撇号内包含的字符串必须是能够执行的命令，执行后会将输出结果替换该命令字符。

  ​	例如：统计当前远程登录到系统(使用pts终端)的用户数量，并将结果保存到变量UserNum中：

  ```shell
  UserNum=`who | grep "pts" |wc -l`
  echo $UserNum
  ```

  ​	不过由于反撇号跟单引号容易混淆，所以这里推荐另外一种与反撇号具有相同功能的用法$()。

  ```shell
  rpm -qf $(which fdsik)					# 找出安装fdisk程序的软件包名称
  ```

  ​	尤其是在嵌套使用时，反撇号将力不能及，这时候就只能用$()：

  ```shell
  FdiskPKG=$(rpm -qf $(which fdisk))
  echo FdiskPKG
  ```

  ​	反撇号和$()除了给变量赋值外，也可以直接用于嵌套执行多条命令，例如将/etc目录打包压缩为一个以当前日期命令的、后缀为.bak的文件

  ```shell
  tar zcf etc_$(date +%F).bak /etc
  ll *.bak
  ```

- **read命令**

  read命令从键盘读入一行内容，并以空格为分隔符，将读入的各字段分别赋值给指定的变量(多余的内容赋值给最后一个变量)，若指定的变量只有一个，则将整行的内容赋值给该变量。

  例如：从键盘输入一整行数据，依次赋值给g1、g2:

  ```shell
  read g1 g2
  aaa bbb
  echo $g1
  echo $g2
  ```



### 2.2.变量算术运算

​	在Shell脚本程序中可以进行一些简单的算术运算，这些运算主要用于脚本程序的过程控制，如循环次数等。

​	常用的算术运算符有：

- “+”，“-”：加减运算；
- “*”，“/”：乘除运算；
- “%”：取模运算；
- “**”：乘方运算。

**默认情况下，shell将所有的变量都视为字符型**。因而如果直接使用运算符在变量之间进行加法运算，那只能实现字符串之间的连接。

```shell
num1=1
num2=2
echo $num1+$num2
# 2+3
```

在shell脚本中要实现变量的算术运算，必须要使用变量运算的特殊格式，主要有以下几种：

**（1）let命令**

​	let是bash内部命令，通过它可以实现变量的算术运算，但需要将运算结果保存到指定变量中：

```shell
let sum =$num1+$num2
echo $sum
```

**（2）$[算术运算表达式]**

```shell
echo $[$num1*$num2]
```

**（3）$((算术运算表达式))**

```shell
echo $(())
```

**通常使用$[算术运算表达式]**。



## 3.Bash配置文件

​	Bash与我们所使用的Linux的其他程序一样，也有自己的配置文件，系统观景变量就是通过这些Bash配置文件来定义的，当我们设置或改变环境变量时，只对当前shell有效，如果要自定义永久有效的环境变量，或者要永久改变环境变量的值，那么就应该修改Bash配置文件。

​	相对于其他程序，Bash配置文件要稍微复杂一些，且配置文件不止一个，是由分散在系统不同位置的配置文件组成，当用户登录shell时，就会去读取并自动执行这些配置文件里的相关设置。Bash的配置文件总体分为两大类：

- profile类文件：这类文件只在用户登录时执行一次；

- bashrc类文件：这类文件不仅在用户登录时执行，而且每当用户打开新的shell或者创建子shell时也会被执行。

  另外，无论时profile文件还是bashrc文件，又都分为全局配置和局部配置两个类别。这样bash配置文件具体就包括以下四种：

- profile全局配置文件：/etc/profile、/etc/profile.d/*.sh;
- profile局部配置文件：~/.bash_profile（~泛指用户的家目录）;
- bashrc全局配置文件：/etc/bashrc；
- bashrc局部配置文件：~/.bashrc。



​	**全局配置文件对系统中所有用户都会生效，**可以为系统中每一个用户初始化工作环境；**局部配置文件只会对相对用户有效，**如果全局配置文件和局部配置文件发生冲突时，会以局部配置文件为准。



## 4.条件测试与比较

​	当需要在shell脚本中选择性的执行任务时，首先要面临的问题就是如何设置判断条件。根据需要判断的条件内容和类型不同，条件测试主要包括文件状态测试、整数值比较、字符串比较，以及同时判断多个条件的逻辑测试。

​	条件测试的结果可以通过预定义变量$?来判断，当$?返回值为0时表示条件测试成功，否则表示测试失败。

**条件测试语句格式如下：**

![image-20220105195837888](https://gitee.com/zou_tangrui/note-pic/raw/master/img/202302171657580.png)

**注意：方括号"[]"的左右两侧与条件表达式之间至少需要有一个空格进行分隔。**

```shell
[ 3 -gt 2]										# 判断3大于2
echo $?
```



### 4.1.测试文件状态

​	文件状态测试是指根据给定的路径名称，判断该名称对应的是文件还是目录，或者 判断文件可读、可写、可执行等。根据所判断的状态不同，在条件表达式中需要使用不同的测试操作符。

​	以下是常用的文件测试操作符：

- -d:测试是否为目录；
- -f:测试是否为文件；
- -e:测试目录或文件是否村则；
- -r:测试当前用户是否有可读权限；
- -w:测试当前用户是否有写入权限；
- -x:测试当前用户是否有可执行权限；
- -L:测试是否为符号连接文件。

```shell
[ -d /etc ]												# 判断/etc是否为目录
echo $?
```



### 4.2.整数值比较

​	整数值比较是指根据给定的两个数值，判断第一个数是否大于、等于、小于........第二个数。但是在用方括号进行比较是，不能使用传统意义的>、=、<等比较符号，这是由于在shell脚本中这些符号都有特殊的意义，如>和<分别表示输出和输入重定向，所以使用这些传统的比较符，必须要在它们前面加上反斜杠"\"进行转移。如"\>"等。

```shell
[ 3\>2 ]
echo $?
[ 3\<2 ]
echo $?
```

​	我们在shell脚本中进行比较时，很少会用到这些传统意义的比较符，取而代之的是一些专门的操作符，下面列出一些常用的操作符：

- -eq:等于；
- -ne:不等于；
- -gt:大于；
- -lt:小于；
- -le:小于等于；
- -ge:大于等于。

```shell
[ 3 -gt 2]
echo $?
[ 3 -lt 2]
echo $?
# 判断变量num的变量是否大于0
num=5
[ $num -gt 0 ]
echo $?
# 判断当前系统登录用户数是否小于等于10
[ $(who | wc -l) -le 10 ]
echo $?
```



### 4.3.字符串比较

​	字符串比较主要指两个字符串是否相同，测试字符串是否为空等。

​	字符串比较的常用操作符有：

- =:匹配；

- !=:不匹配；

- -z:检查字符串是否为空。

  需要注意的是，**在进行字符串比较时，最好为字符串加上引号，并且等号两侧最好留有空格。**

```shell
# 提示用户输入一个文件路径 并判断是否是"/etc/fstab"
read -p "Location:" FilePath
Location:/etc/fstab
[ $FilePath = "/etc/fstab"]
echo $?

# 判断当前用户是否为root
[ $USER = "root"]
echo $?
```

